<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braze: Build Your Own ML Model</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Braze Brand Fonts & Colors Override */
        :root {
            --braze-orange: #FFA524;
            --braze-pink: #FFA4FB;
            --braze-purple: #801ED7;
            --braze-dark-purple: #300266;
            --braze-light-orange: #FFD4BC;
            --braze-light-pink: #F8D3E8;
            --braze-light-purple: #C9C4EF;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--braze-dark-purple);
            background-color: #f8f9fa;
        }
        .braze-gradient-text {
            background: linear-gradient(90deg, #FFA524, #FFA4FB);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .braze-gradient-bg {
            background: linear-gradient(135deg, #801ED7 0%, #300266 100%);
        }
        select, input {
            border: 2px solid #C9C4EF;
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            color: #300266;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #801ED7;
        }
        
        /* Tooltip Styling */
        .tooltip-trigger:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #300266;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 100;
            margin-bottom: 0.5rem;
        }
        .node-connector {
            position: absolute;
            background-color: #CBD5E1;
            z-index: 0;
        }
        .node-label {
            position: absolute;
            background-color: white;
            padding: 0 4px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- HELPER FUNCTIONS ---

        const getAttributes = () => [
            { key: 'Sex', type: 'categorical', options: ['male', 'female'], help: 'Gender of passenger' },
            { key: 'Age', type: 'numeric', min: 0, max: 100, help: 'Age in years' },
            { key: 'Pclass', type: 'categorical', options: [1, 2, 3], help: 'Ticket Class (1st, 2nd, 3rd)' },
            { key: 'Fare', type: 'numeric', min: 0, max: 500, help: 'Ticket fare cost' },
            { key: 'SibSp', type: 'numeric', min: 0, max: 8, help: '# of siblings / spouses aboard' },
            { key: 'Embarked', type: 'categorical', options: ['S', 'C', 'Q'], help: 'Port: Southampton, Cherbourg, Queenstown' }
        ];

        const evaluateCondition = (row, condition) => {
            const val = row[condition.feature];
            if (condition.type === 'categorical') {
                return String(val) === String(condition.value);
            } else {
                const rowVal = parseFloat(val);
                const condVal = parseFloat(condition.value);
                if (condition.operator === '>') return rowVal > condVal;
                if (condition.operator === '<') return rowVal < condVal;
                if (condition.operator === '=') return rowVal === condVal;
                if (condition.operator === '>=') return rowVal >= condVal;
                if (condition.operator === '<=') return rowVal <= condVal;
            }
            return false;
        };

        const getPredictionForLeaf = (leafData) => {
            if (leafData.length === 0) return 0; // Default if empty
            const survived = leafData.filter(r => r.Survived === 1).length;
            const rate = survived / leafData.length;
            return rate > 0.5 ? 1 : 0;
        };

        const predictSingleTree = (row, treeConfig, allTrainingData) => {
            // Root
            if (evaluateCondition(row, treeConfig.root)) {
                // Went Left (True)
                if (evaluateCondition(row, treeConfig.leftNode)) {
                    // Left-Left Leaf
                    // To perform automatic prediction on a single row, we need to know the majority vote of the TRAINING data at this leaf.
                    // We calculate this dynamically based on the full training set.
                    const rootTrueData = allTrainingData.filter(d => evaluateCondition(d, treeConfig.root));
                    const leafData = rootTrueData.filter(d => evaluateCondition(d, treeConfig.leftNode));
                    return getPredictionForLeaf(leafData);
                } else {
                    // Left-Right Leaf
                    const rootTrueData = allTrainingData.filter(d => evaluateCondition(d, treeConfig.root));
                    const leafData = rootTrueData.filter(d => !evaluateCondition(d, treeConfig.leftNode));
                    return getPredictionForLeaf(leafData);
                }
            } else {
                // Went Right (False)
                if (evaluateCondition(row, treeConfig.rightNode)) {
                    // Right-Left Leaf
                    const rootFalseData = allTrainingData.filter(d => !evaluateCondition(d, treeConfig.root));
                    const leafData = rootFalseData.filter(d => evaluateCondition(d, treeConfig.rightNode));
                    return getPredictionForLeaf(leafData);
                } else {
                    // Right-Right Leaf
                    const rootFalseData = allTrainingData.filter(d => !evaluateCondition(d, treeConfig.root));
                    const leafData = rootFalseData.filter(d => !evaluateCondition(d, treeConfig.rightNode));
                    return getPredictionForLeaf(leafData);
                }
            }
        };

        const calculateAccuracy = (data, treeConfig, allTrainingData) => {
            if (!data || data.length === 0) return 0;
            let correct = 0;
            data.forEach(row => {
                const prediction = predictSingleTree(row, treeConfig, allTrainingData);
                if (prediction === row.Survived) correct++;
            });
            return (correct / data.length * 100).toFixed(1);
        };

        // --- COMPONENTS ---

        const Header = ({ activeTab, setActiveTab }) => (
            <div className="braze-gradient-bg text-white shadow-lg sticky top-0 z-50">
                <div className="container mx-auto px-6 py-4 flex justify-between items-center">
                    <div className="flex items-center space-x-3">
                        <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-[#801ED7] font-bold text-xl shadow">
                            <i className="fa-solid fa-tree"></i>
                        </div>
                        <div>
                            <h1 className="text-xl font-bold tracking-tight">Braze ML Builder</h1>
                            <p className="text-xs opacity-80 font-medium">Titanic Survival Prediction</p>
                        </div>
                    </div>
                    <nav className="hidden md:flex space-x-1">
                        {['Intro', 'Tree 1', 'Tree 2', 'Tree 3', 'Ensemble', 'Data'].map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-2 rounded-lg transition-all text-sm font-bold ${
                                    activeTab === tab 
                                    ? 'bg-white text-[#801ED7] shadow-md transform scale-105' 
                                    : 'text-white/90 hover:bg-white/10 hover:text-white'
                                }`}
                            >
                                {tab}
                            </button>
                        ))}
                    </nav>
                </div>
                <div className="md:hidden flex overflow-x-auto pb-2 px-2 space-x-2 scrollbar-hide">
                     {['Intro', 'Tree 1', 'Tree 2', 'Tree 3', 'Ensemble', 'Data'].map(tab => (
                            <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-3 py-2 whitespace-nowrap rounded-lg text-xs font-bold ${
                                    activeTab === tab 
                                    ? 'bg-white text-[#801ED7]' 
                                    : 'text-white/90 hover:bg-white/10'
                                }`}
                            >
                                {tab}
                            </button>
                        ))}
                </div>
            </div>
        );

        const Intro = ({ onStart }) => (
            <div className="max-w-4xl mx-auto mt-10 p-8 bg-white rounded-xl shadow-lg animate-fade-in">
                <h2 className="text-3xl font-extrabold text-[#300266] mb-6 border-b-2 border-[#F8D3E8] pb-4">
                    Welcome to the ML Builder
                </h2>
                <div className="space-y-6 text-gray-700">
                    <p className="text-lg leading-relaxed">
                        The goal of this simulation is to build a <span className="font-bold text-[#801ED7]">Random Forest model</span> manually. 
                        You will construct <strong>3 distinct decision trees</strong> to predict whether a passenger on the Titanic survived or died.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 my-8">
                        <div className="p-6 bg-[#F8D3E8]/30 rounded-xl border border-[#F8D3E8] hover:shadow-md transition-shadow">
                            <i className="fa-solid fa-code-branch text-[#91186E] text-3xl mb-3"></i>
                            <h3 className="font-bold text-[#91186E] text-lg">1. Build Trees</h3>
                            <p className="text-sm text-gray-600 mt-2">Define splits (e.g., Age > 20) to categorize passengers into smaller groups.</p>
                        </div>
                        <div className="p-6 bg-[#C9C4EF]/30 rounded-xl border border-[#C9C4EF] hover:shadow-md transition-shadow">
                            <i className="fa-solid fa-chart-line text-[#300266] text-3xl mb-3"></i>
                            <h3 className="font-bold text-[#300266] text-lg">2. Check Accuracy</h3>
                            <p className="text-sm text-gray-600 mt-2">See how your rules perform on Training vs Test data in real-time.</p>
                        </div>
                        <div className="p-6 bg-[#FFD4BC]/30 rounded-xl border border-[#FFD4BC] hover:shadow-md transition-shadow">
                            <i className="fa-solid fa-people-group text-[#E9371F] text-3xl mb-3"></i>
                            <h3 className="font-bold text-[#E9371F] text-lg">3. Ensemble</h3>
                            <p className="text-sm text-gray-600 mt-2">Combine all 3 trees to create a superior "Forest" model via voting.</p>
                        </div>
                    </div>
                    
                    <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500 text-sm text-blue-800">
                        <i className="fas fa-info-circle mr-2"></i>
                        <strong>Tip:</strong> The <strong>Data Tab</strong> is now available at the end to explore your CSV data!
                    </div>

                    <button 
                        onClick={onStart}
                        className="mt-6 bg-[#FFA524] hover:bg-[#E9371F] text-white font-bold py-4 px-10 rounded-xl shadow-md transition-all transform hover:scale-105 hover:shadow-lg flex items-center gap-2"
                    >
                        <span>Start Building Tree 1</span>
                        <i className="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        );

        const DataView = ({ data }) => {
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'asc' });

            const sortedData = useMemo(() => {
                let sortableItems = [...data];
                if (sortConfig !== null) {
                    sortableItems.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) {
                            return sortConfig.direction === 'asc' ? -1 : 1;
                        }
                        if (a[sortConfig.key] > b[sortConfig.key]) {
                            return sortConfig.direction === 'asc' ? 1 : -1;
                        }
                        return 0;
                    });
                }
                return sortableItems;
            }, [data, sortConfig]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            return (
                <div className="max-w-6xl mx-auto mt-6 px-4">
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="p-6 border-b border-gray-200">
                            <h2 className="text-2xl font-bold text-[#300266]">Passenger Data</h2>
                            <p className="text-sm text-gray-500">
                                Loaded {data.length} records from <code>data/titanicdata.csv</code>.
                            </p>
                        </div>
                        <div className="overflow-x-auto max-h-[70vh]">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        {['id', 'Survived', 'Pclass', 'Sex', 'Age', 'SibSp', 'Fare', 'Embarked', 'Group'].map(key => (
                                            <th 
                                                key={key}
                                                onClick={() => requestSort(key)}
                                                className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                                            >
                                                <div className="flex items-center gap-1">
                                                    {key}
                                                    {sortConfig.key === key && (
                                                        <i className={`fas fa-sort-${sortConfig.direction === 'asc' ? 'up' : 'down'}`}></i>
                                                    )}
                                                </div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {sortedData.map((row) => (
                                        <tr key={row.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{row.id}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${row.Survived === 1 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                    {row.Survived === 1 ? 'Survived' : 'Died'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.Pclass}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.Sex}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.Age}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.SibSp}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.Fare}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.Embarked}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{row.Group}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const StatBox = ({ data, label }) => {
            const count = data.length;
            const survived = data.filter(r => r.Survived === 1).length;
            const rate = count > 0 ? ((survived / count) * 100).toFixed(0) : 0;
            
            return (
                <div className="mt-2 bg-white/80 p-2 rounded text-xs w-full border border-gray-200 shadow-sm text-center">
                    <div className="font-bold text-[#300266] border-b border-gray-100 mb-1 pb-1">{label}</div>
                    <div className="grid grid-cols-2 gap-1 text-[10px]">
                        <div className="text-gray-500">Total:</div>
                        <div className="font-mono font-bold">{count}</div>
                        <div className="text-green-600">Survived:</div>
                        <div className="font-mono font-bold">{survived} ({rate}%)</div>
                    </div>
                </div>
            );
        };

        const NodeConfig = ({ label, config, onChange, isRoot, nodeData, description }) => {
            const attributes = getAttributes();
            const selectedAttr = attributes.find(a => a.key === config.feature);

            const handleChange = (field, val) => {
                onChange({ ...config, [field]: val });
            };

            return (
                <div className={`p-4 rounded-xl border-2 shadow-md transition-all ${isRoot ? 'border-[#801ED7] bg-[#F3E5F5]' : 'border-[#FFA524] bg-[#FFF3E0]'} relative w-64`}>
                    <div className={`absolute -top-3 left-4 px-3 py-0.5 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm ${isRoot ? 'bg-[#801ED7] text-white' : 'bg-[#FFA524] text-white'}`}>
                        {label}
                    </div>
                    
                    <div className="flex flex-col gap-3 mt-2">
                        <div className="flex gap-2 relative">
                            <div className="w-full relative tooltip-trigger" data-tooltip={selectedAttr?.help}>
                                <select 
                                    className="w-full text-sm font-bold bg-white"
                                    value={config.feature}
                                    onChange={(e) => handleChange('feature', e.target.value)}
                                >
                                    {attributes.map(attr => <option key={attr.key} value={attr.key}>{attr.key}</option>)}
                                </select>
                            </div>
                            
                            {selectedAttr?.type === 'categorical' ? (
                                <div className="text-sm font-bold flex items-center px-2 bg-white/50 rounded border border-transparent">=</div>
                            ) : (
                                <select 
                                    className="w-20 text-sm font-bold bg-white"
                                    value={config.operator}
                                    onChange={(e) => handleChange('operator', e.target.value)}
                                >
                                    <option value=">">&gt;</option>
                                    <option value="<">&lt;</option>
                                    <option value=">=">&ge;</option>
                                    <option value="<=">&le;</option>
                                </select>
                            )}
                        </div>

                        {selectedAttr?.type === 'categorical' ? (
                             <select 
                                className="w-full text-sm bg-white"
                                value={config.value}
                                onChange={(e) => handleChange('value', e.target.value)}
                            >
                                {selectedAttr.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                            </select>
                        ) : (
                            <input 
                                type="number" 
                                className="w-full text-sm bg-white"
                                value={config.value}
                                onChange={(e) => handleChange('value', e.target.value)}
                            />
                        )}
                        
                        <StatBox data={nodeData} label={description || "All Passengers"} />
                    </div>
                </div>
            );
        };

        const LeafNode = ({ data, description }) => {
            const count = data.length;
            const survived = data.filter(r => r.Survived === 1).length;
            const rate = count > 0 ? (survived / count) : 0;
            const prediction = rate > 0.5 ? 1 : 0;

            return (
                <div className="flex flex-col items-center w-64">
                    <div className="h-8 w-0.5 bg-gray-300 mb-2"></div>
                    <div className="bg-white border-2 border-gray-200 rounded-xl shadow-lg p-4 w-full relative">
                         <div className="text-[10px] font-bold text-gray-400 uppercase tracking-widest text-center mb-2">
                            Final Decision
                        </div>
                        <div className={`text-center py-2 rounded-lg font-bold text-white mb-3 shadow-inner ${prediction === 1 ? 'bg-[#10B981]' : 'bg-[#EF4444]'}`}>
                            {prediction === 1 ? 'PREDICT: SURVIVES' : 'PREDICT: DIES'}
                        </div>
                        
                        <div className="text-[10px] text-gray-500 text-center mb-2 italic border-b border-gray-100 pb-2">
                            "{description}"
                        </div>

                        <div className="grid grid-cols-2 gap-2 text-xs">
                             <div className="text-gray-600">Subset Size:</div>
                             <div className="font-bold text-right">{count}</div>
                             <div className="text-gray-600">Survivors:</div>
                             <div className="font-bold text-right text-green-600">{survived}</div>
                             <div className="text-gray-600">Survival %:</div>
                             <div className="font-bold text-right">{(rate * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TreeBuilder = ({ treeId, config, setConfig, data }) => {
            const trainData = data.filter(d => d.Group === 'Train');
            const testData = data.filter(d => d.Group === 'Test');

            const trainAcc = calculateAccuracy(trainData, config, trainData);
            const testAcc = calculateAccuracy(testData, config, trainData);

            // Determine if overfitting (Train much higher than Test)
            const isOverfitting = (parseFloat(trainAcc) - parseFloat(testAcc)) > 15;

            const updateNode = (nodeKey, newConfig) => {
                setConfig(prev => ({ ...prev, [nodeKey]: newConfig }));
            };

            // --- DATA SUBSET CALCULATION ---
            // Root
            const rootData = trainData;
            
            // Level 1 Splits
            const leftData = rootData.filter(d => evaluateCondition(d, config.root));
            const rightData = rootData.filter(d => !evaluateCondition(d, config.root));
            
            // Level 2 Splits (Leafs)
            const leftLeafTrueData = leftData.filter(d => evaluateCondition(d, config.leftNode));
            const leftLeafFalseData = leftData.filter(d => !evaluateCondition(d, config.leftNode));
            
            const rightLeafTrueData = rightData.filter(d => evaluateCondition(d, config.rightNode));
            const rightLeafFalseData = rightData.filter(d => !evaluateCondition(d, config.rightNode));

            // --- DESCRIPTIONS ---
            const rootDesc = `${config.root.feature} ${config.root.operator === '=' ? '' : config.root.operator} ${config.root.value}`;
            const rootNotDesc = `NOT (${rootDesc})`;
            
            const leftDesc = `${config.leftNode.feature} ${config.leftNode.operator === '=' ? '' : config.leftNode.operator} ${config.leftNode.value}`;
            const rightDesc = `${config.rightNode.feature} ${config.rightNode.operator === '=' ? '' : config.rightNode.operator} ${config.rightNode.value}`;

            return (
                <div className="max-w-7xl mx-auto mt-6 px-4">
                    {/* Stats Header */}
                    <div className="bg-white rounded-xl shadow p-4 mb-8 flex flex-col md:flex-row justify-between items-center border-l-4 border-[#801ED7]">
                        <div>
                            <h2 className="text-2xl font-bold text-[#300266]">Decision Tree #{treeId}</h2>
                            <p className="text-sm text-gray-500">Configure nodes. Predictions are automatic based on majority vote > 50%.</p>
                        </div>
                        <div className="flex gap-6 mt-4 md:mt-0">
                            <div className="text-center p-2 bg-gray-50 rounded-lg">
                                <p className="text-xs uppercase text-gray-400 font-bold">Train Accuracy</p>
                                <p className="text-2xl font-bold text-[#FFA524]">{trainAcc}%</p>
                            </div>
                            <div className="text-center p-2 bg-gray-50 rounded-lg">
                                <p className="text-xs uppercase text-gray-400 font-bold">Test Accuracy</p>
                                <p className={`text-2xl font-bold ${parseFloat(testAcc) > 70 ? 'text-green-500' : 'text-[#801ED7]'}`}>
                                    {testAcc}%
                                </p>
                            </div>
                        </div>
                    </div>

                     {isOverfitting && (
                        <div className="mb-6 bg-red-50 border-l-4 border-red-400 text-red-700 px-4 py-3 rounded relative shadow-sm" role="alert">
                            <strong className="font-bold">Warning: Overfitting!</strong>
                            <span className="block sm:inline"> Your training score is much higher than your test score. This means your rules are memorizing the data rather than finding general patterns.</span>
                        </div>
                    )}

                    {/* Tree Visualizer */}
                    <div className="bg-slate-50 border border-gray-200 rounded-xl p-8 shadow-inner overflow-x-auto">
                        <div className="flex flex-col items-center min-w-[900px]">
                            
                            {/* Level 1: Root */}
                            <div className="z-10">
                                <NodeConfig 
                                    label="Root Split" 
                                    isRoot={true}
                                    config={config.root} 
                                    onChange={(c) => updateNode('root', c)} 
                                    nodeData={rootData}
                                    description="All Training Passengers"
                                />
                            </div>

                            {/* Connectors L1 -> L2 */}
                            <div className="flex w-full justify-center h-16 relative">
                                <div className="absolute top-0 bottom-0 border-l-2 border-dashed border-gray-300 left-1/2"></div>
                                <div className="absolute top-1/2 w-[600px] border-t-2 border-dashed border-gray-300"></div>
                                <div className="absolute top-1/2 left-[calc(50%-300px)] h-1/2 border-l-2 border-dashed border-gray-300"></div>
                                <div className="absolute top-1/2 right-[calc(50%-300px)] h-1/2 border-r-2 border-dashed border-gray-300"></div>
                                
                                <div className="absolute top-1/2 left-[calc(50%-150px)] -mt-3 bg-slate-50 px-2 text-xs text-green-600 font-bold">TRUE</div>
                                <div className="absolute top-1/2 right-[calc(50%-150px)] -mt-3 bg-slate-50 px-2 text-xs text-red-600 font-bold">FALSE</div>
                            </div>

                            {/* Level 2: Branches */}
                            <div className="flex justify-center gap-[100px] w-full">
                                {/* Left Branch (Root True) */}
                                <div className="flex flex-col items-center">
                                    <NodeConfig 
                                        label="If True..." 
                                        config={config.leftNode} 
                                        onChange={(c) => updateNode('leftNode', c)}
                                        nodeData={leftData}
                                        description={rootDesc}
                                    />
                                    {/* Connectors L2 -> L3 */}
                                    <div className="h-12 w-[300px] relative mt-2">
                                        <div className="absolute top-0 h-6 left-1/2 border-l-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 w-full border-t-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 h-6 left-0 border-l-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 h-6 right-0 border-r-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 left-1/4 -mt-3 bg-slate-50 px-1 text-[10px] text-green-600 font-bold">TRUE</div>
                                        <div className="absolute top-6 right-1/4 -mt-3 bg-slate-50 px-1 text-[10px] text-red-600 font-bold">FALSE</div>
                                    </div>
                                    <div className="flex justify-between w-[340px]">
                                        <LeafNode data={leftLeafTrueData} description={`${rootDesc} AND ${leftDesc}`} />
                                        <LeafNode data={leftLeafFalseData} description={`${rootDesc} AND NOT(${leftDesc})`} />
                                    </div>
                                </div>

                                {/* Right Branch (Root False) */}
                                <div className="flex flex-col items-center">
                                    <NodeConfig 
                                        label="If False..." 
                                        config={config.rightNode} 
                                        onChange={(c) => updateNode('rightNode', c)} 
                                        nodeData={rightData}
                                        description={rootNotDesc}
                                    />
                                     {/* Connectors L2 -> L3 */}
                                     <div className="h-12 w-[300px] relative mt-2">
                                        <div className="absolute top-0 h-6 left-1/2 border-l-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 w-full border-t-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 h-6 left-0 border-l-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 h-6 right-0 border-r-2 border-dashed border-gray-300"></div>
                                        <div className="absolute top-6 left-1/4 -mt-3 bg-slate-50 px-1 text-[10px] text-green-600 font-bold">TRUE</div>
                                        <div className="absolute top-6 right-1/4 -mt-3 bg-slate-50 px-1 text-[10px] text-red-600 font-bold">FALSE</div>
                                    </div>
                                    <div className="flex justify-between w-[340px]">
                                        <LeafNode data={rightLeafTrueData} description={`${rootNotDesc} AND ${rightDesc}`} />
                                        <LeafNode data={rightLeafFalseData} description={`${rootNotDesc} AND NOT(${rightDesc})`} />
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const EnsembleView = ({ configs, data }) => {
            const trainData = data.filter(d => d.Group === 'Train');
            const testData = data.filter(d => d.Group === 'Test');
            
            // Calculate individual stats
            const stats = configs.map((cfg, idx) => {
                let correct = 0;
                testData.forEach(row => {
                    if (predictSingleTree(row, cfg, trainData) === row.Survived) correct++;
                });
                return { id: idx + 1, acc: (correct / testData.length * 100).toFixed(1) };
            });

            // Calculate Ensemble Stats (Majority Vote)
            let ensembleCorrect = 0;
            testData.forEach(row => {
                const v1 = predictSingleTree(row, configs[0], trainData);
                const v2 = predictSingleTree(row, configs[1], trainData);
                const v3 = predictSingleTree(row, configs[2], trainData);
                
                const sum = v1 + v2 + v3;
                const prediction = sum >= 2 ? 1 : 0; // Majority vote
                
                if (prediction === row.Survived) ensembleCorrect++;
            });
            const ensembleAcc = (ensembleCorrect / testData.length * 100).toFixed(1);

            return (
                <div className="max-w-4xl mx-auto mt-10 p-6 animate-fade-in">
                    <h2 className="text-3xl font-bold text-[#300266] mb-8 text-center">Ensemble Results</h2>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-12">
                        {stats.map(s => (
                            <div key={s.id} className="bg-white p-6 rounded-xl shadow text-center border-t-4 border-[#FFA524]">
                                <h3 className="text-gray-500 font-bold uppercase text-xs mb-2">Tree {s.id}</h3>
                                <div className="text-3xl font-bold text-[#300266]">{s.acc}%</div>
                            </div>
                        ))}
                        <div className="bg-[#300266] p-6 rounded-xl shadow text-center border-t-4 border-[#FFA4FB] transform scale-105">
                            <h3 className="text-[#FFA4FB] font-bold uppercase text-xs mb-2">Combined Model</h3>
                            <div className="text-3xl font-bold text-white">{ensembleAcc}%</div>
                        </div>
                    </div>

                    <div className="bg-white p-8 rounded-xl shadow-lg">
                        <h3 className="font-bold text-xl mb-4 text-[#300266]">Why Ensemble?</h3>
                        <p className="text-gray-600 mb-6 leading-relaxed">
                            In a single decision tree, errors can happen due to noise or specific biases in that tree's rules. 
                            By combining the votes of three different trees, we smooth out these errors. If Tree 1 and Tree 2 say "Survive" but Tree 3 says "Die", the majority vote (Survive) often corrects the mistake.
                            This is the core concept behind <strong>Random Forests</strong> and <strong>Gradient Boosting</strong>.
                        </p>
                        
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between text-xs font-bold uppercase text-gray-400 mb-1">
                                    <span>Single Tree Average</span>
                                    <span>Goal: 70%+</span>
                                </div>
                                <div className="h-4 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div 
                                        className="bg-gray-400 h-full transition-all duration-1000" 
                                        style={{ width: `${stats[0].acc}%` }} 
                                    ></div>
                                </div>
                            </div>

                            <div>
                                <div className="flex justify-between text-xs font-bold uppercase text-[#801ED7] mb-1">
                                    <span>Ensemble Accuracy</span>
                                    <span>{ensembleAcc}%</span>
                                </div>
                                <div className="h-4 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div 
                                        className="braze-gradient-bg h-full transition-all duration-1000" 
                                        style={{ width: `${ensembleAcc}%` }} 
                                    ></div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-6 text-sm text-center text-gray-500 bg-gray-50 p-4 rounded-lg">
                             <i className="fas fa-lightbulb text-[#FFA524] mr-2"></i>
                             <strong>Strategy Tip:</strong> If your Combined Score is lower than your best tree, try to make your trees more different from each other! Use different variables for the root splits.
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('Intro');
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Load Data on Mount
            useEffect(() => {
                fetch('data/titanicdata.csv')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Could not fetch data. Ensure 'data/titanicdata.csv' exists relative to index.html");
                        }
                        return response.text();
                    })
                    .then(csvText => {
                        Papa.parse(csvText, {
                            header: true,
                            skipEmptyLines: true,
                            dynamicTyping: true, // Automatically converts numbers
                            complete: (results) => {
                                // Transform keys to match App expectations if necessary
                                // CSV Headers: PassengerId, Survived, TicketClass, Name, Sex, Age, SibSp, ParCh, Fare, Embarked, Title, Train/Test Group
                                // App Expects: id, Survived, Pclass, Sex, Age, SibSp, Fare, Embarked, Group
                                const transformed = results.data.map(row => ({
                                    id: row['PassengerId'],
                                    Survived: row['Survived'],
                                    Pclass: row['TicketClass'],
                                    Sex: row['Sex'],
                                    Age: row['Age'],
                                    SibSp: row['SibSp'],
                                    Fare: row['Fare'],
                                    Embarked: row['Embarked'],
                                    Group: row['Train/Test Group']
                                }));
                                setData(transformed);
                                setLoading(false);
                            },
                            error: (err) => {
                                setError(err.message);
                                setLoading(false);
                            }
                        });
                    })
                    .catch(err => {
                        console.error(err);
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            // Default Configs for 3 Trees
            const defaultTree = {
                root: { feature: 'Sex', operator: '=', value: 'male', type: 'categorical' },
                leftNode: { feature: 'Age', operator: '>', value: 10, type: 'numeric' },
                leftLeafTrue: 0,
                leftLeafFalse: 1,
                rightNode: { feature: 'Pclass', operator: '=', value: 3, type: 'categorical' },
                rightLeafTrue: 0,
                rightLeafFalse: 1
            };

            const [tree1, setTree1] = useState({...defaultTree, root: { feature: 'Sex', operator: '=', value: 'male', type: 'categorical' }});
            const [tree2, setTree2] = useState({...defaultTree, root: { feature: 'Fare', operator: '>', value: 20, type: 'numeric' }});
            const [tree3, setTree3] = useState({...defaultTree, root: { feature: 'Pclass', operator: '=', value: 3, type: 'categorical' }});

            if (loading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
                        <div className="w-16 h-16 border-4 border-[#C9C4EF] border-t-[#801ED7] rounded-full animate-spin mb-4"></div>
                        <h2 className="text-[#300266] font-bold text-xl">Loading Titanic Data...</h2>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50 p-6">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-lg text-center border-l-4 border-red-500">
                            <i className="fa-solid fa-triangle-exclamation text-red-500 text-4xl mb-4"></i>
                            <h2 className="text-red-700 font-bold text-xl mb-2">Error Loading Data</h2>
                            <p className="text-gray-600 mb-4">{error}</p>
                            <div className="bg-gray-100 p-4 rounded text-sm text-left font-mono">
                                Expected Path: /data/titanicdata.csv<br/>
                                Check your browser console for more details.
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <Header activeTab={activeTab} setActiveTab={setActiveTab} />
                    
                    <main>
                        {activeTab === 'Intro' && <Intro onStart={() => setActiveTab('Tree 1')} />}

                        {activeTab === 'Data' && <DataView data={data} />}
                        
                        {activeTab === 'Tree 1' && (
                            <TreeBuilder 
                                treeId={1} 
                                config={tree1} 
                                setConfig={setTree1} 
                                data={data} 
                            />
                        )}
                        
                        {activeTab === 'Tree 2' && (
                            <TreeBuilder 
                                treeId={2} 
                                config={tree2} 
                                setConfig={setTree2} 
                                data={data} 
                            />
                        )}
                        
                        {activeTab === 'Tree 3' && (
                            <TreeBuilder 
                                treeId={3} 
                                config={tree3} 
                                setConfig={setTree3} 
                                data={data} 
                            />
                        )}

                        {activeTab === 'Ensemble' && (
                            <EnsembleView 
                                configs={[tree1, tree2, tree3]} 
                                data={data} 
                            />
                        )}
                    </main>

                    {activeTab !== 'Intro' && activeTab !== 'Ensemble' && activeTab !== 'Data' && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 flex justify-between items-center shadow-lg z-50">
                            <div className="text-sm text-gray-500 hidden md:block">
                                <span className="font-bold text-[#801ED7]">Goal:</span> Tweak the splits to maximize accuracy without overfitting.
                            </div>
                            <div className="flex gap-2 w-full md:w-auto">
                                <button 
                                    onClick={() => {
                                        const tabs = ['Tree 1', 'Tree 2', 'Tree 3', 'Ensemble'];
                                        const idx = tabs.indexOf(activeTab);
                                        if(idx > 0) setActiveTab(tabs[idx-1]);
                                    }}
                                    className="flex-1 md:flex-none px-4 py-2 border border-gray-300 rounded hover:bg-gray-100 font-medium"
                                >
                                    Previous
                                </button>
                                <button 
                                    onClick={() => {
                                        const tabs = ['Tree 1', 'Tree 2', 'Tree 3', 'Ensemble'];
                                        const idx = tabs.indexOf(activeTab);
                                        if(idx < tabs.length - 1) setActiveTab(tabs[idx+1]);
                                    }}
                                    className="flex-1 md:flex-none px-6 py-2 bg-[#801ED7] text-white font-bold rounded shadow hover:bg-[#300266] transition-colors"
                                >
                                    Next Step &rarr;
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
